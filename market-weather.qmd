---
title: "Market Weather Report"
format: 
  html:
    embed-resources: true
    self-contained: true
    theme: none
    css: market-weather.css
---

```{r setup}
#| include: false

suppressPackageStartupMessages({
  library(tidyverse)
  library(quantmod)
  library(tidyquant)
  library(rvest)
  library(httr)
  library(jsonlite)
  library(kableExtra)
  library(lubridate)
  library(DT)
})

source("market-weather-functions.R")
source("market-weather-indices.R")

# Time periods
current_date <- Sys.Date()
start_date <- current_date - days(30)

# Fetch and process data
market_data <- fetch_all_market_data(market_indices, start_date)
weather_summary <- calculate_market_weather(market_data)
```

:::{.market-weather-widget}
# Market Weather Report

```{r weather-table}
#| echo: false

render_weather_table(weather_summary)
```

::: {.legend-container}
🌞 Exceptional (>5%) | 🌤️ Very Strong (3-5%) | ⛅ Strong (1-3%) | 🌥️ Positive (0-1%) | 
☁️ Stable (-1-0%) | 🌧️ Cautious (-3--1%) | ⛈️ Weak (-5--3%) | 🌪️ Very Weak (-7--5%) | ⚡ Critical (<-7%)
:::

::: {.widget-footer}
Updated: `r format(Sys.time(), "%B %d, %Y at %H:%M %Z")`
:::
:::

```{js}
function showPeriod(period) {
  const table = $('.weather-table').DataTable();
  const periodColumns = {
    'daily': 2,
    'weekly': 3,
    'monthly': 4
  };
  
  Object.values(periodColumns).forEach(col => table.column(col).visible(false));
  table.column(periodColumns[period]).visible(true);
  
  $('.period-button').removeClass('active');
  $(`#${period}-button`).addClass('active');
}

$(document).ready(function() {
  showPeriod('daily');
});
```